<?xml version="1.0" encoding="UTF-8"?>
<job
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns="urn:proactive:jobdescriptor:3.14" xsi:schemaLocation="urn:proactive:jobdescriptor:3.14 http://www.activeeon.com/public_content/schemas/proactive/jobdescriptor/3.14/schedulerjob.xsd"  name="AWS_Lambda_Get_Function" projectName="Cloud Services" tags="AWS Lambda,Serverless Computing,Function" priority="normal" onTaskError="continueJobExecution"  maxNumberOfExecution="2"  >
  <variables>
    <variable name="ACCESS_KEY" value="my_access_key" model="PA:NOT_EMPTY_STRING" description="S3 user access key" group="Lambda Authentication" advanced="false" hidden="false"/>
    <variable name="SECRET_KEY" value="${ACCESS_KEY}" model="PA:CREDENTIAL" description="S3 user secret key" group="Lambda Authentication" advanced="false" hidden="false"/>
    <variable name="REGION" value="eu-west-3" model="PA:NOT_EMPTY_STRING" description="Specify the region to use in your command." group="Lambda Authentication" advanced="false" hidden="false"/>
    <variable name="FUNCTION_NAME" value="my_function" model="NOT_EMPTY_STRING" description="The name of the Lambda function, version, or alias." group="Operation Parameters" advanced="false" hidden="false"/>
    <variable name="FUNCTION_QUALIFIER" value=""  description="Specify a version or alias to invoke a published version of the function." group="Operation Parameters" advanced="false" hidden="false"/>
  </variables>
  <description>
    <![CDATA[ AWS allows you to run code without the need to provision or manage servers, and only pay for the computing time you use. The AWS Lambda Connector provides you the ability to interact with your Lambda functions provisioned on AWS. It allows you to manage or use the function's response payload in an effective manner.
Before you can run this connector, you need to have an AWS IAM credentials and to know the region where the AWS Lambda function is located. ]]>
  </description>
  <genericInformation>
    <info name="bucketName" value="it-application-connectors"/>
    <info name="workflow.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/lambda.png"/>
    <info name="group" value="public-objects"/>
  </genericInformation>
  <taskFlow>
    <task name="AWS_Lambda_Get_Function"
    preciousResult="true"
    fork="true"
    runAsMe="true" >
      <description>
        <![CDATA[ A task that returns information about the function or function version, with a link to download the deployment package that's valid for 10 minutes. If  you specify a function version, only details that are specific to that version are returned. ]]>
      </description>
      <variables>
        <variable name="OPTIONS" value="--no-paginate" inherited="false"  description="Specify the Lambda operation options that can be added to the command execution." group="Input Data" advanced="false" hidden="false"/>
      </variables>
      <genericInformation>
        <info name="task.icon" value="/automation-dashboard/styles/patterns/img/wf-icons/lambda.png"/>
        <info name="Task.Documentation" value="https://docs.aws.amazon.com/lambda/latest/dg/API_GetFunction.html"/>
      </genericInformation>
      <scriptExecutable>
        <script>
          <code language="bash">
            <![CDATA[
ACCESS_KEY=$variables_ACCESS_KEY
CRED_KEY=credentials_$ACCESS_KEY
SECRET_KEY=${!CRED_KEY}
REGION="$variables_REGION"
FUNCTION_NAME="$variables_FUNCTION_NAME"
QUALIFIER=$variables_FUNCTION_QUALIFIER
OPTIONS="$variables_OPTIONS"

mkdir .aws
cd .aws
echo -e "[default] \n aws_access_key_id = $ACCESS_KEY \n aws_secret_access_key = $SECRET_KEY \n" >> credentials

COMMAND="docker run --rm -i -v $localspace/.aws:/root/.aws -v $localspace:/aws amazon/aws-cli lambda get-function --function-name $FUNCTION_NAME $OPTIONS --region $REGION"


if [ ! -z "$QUALIFIER" ]; then
    COMMAND="$COMMAND --qualifier $QUALIFIER"
fi

echo $COMMAND

COMMAND_OUTPUT=$(eval $COMMAND 2>&1)
echo $COMMAND_OUTPUT

cd ..
echo -e "$COMMAND_OUTPUT" > Get_Function_Output
]]>
          </code>
        </script>
      </scriptExecutable>
      <post>
        <script>
          <code language="groovy">
            <![CDATA[
import com.google.common.net.MediaType

file = new File("Get_Function_Output")
result = file.getBytes()
resultMetadata.put("file.name", "Get_Function_Output")
resultMetadata.put("file.extension", ".json")
resultMetadata.put("content.type", MediaType.JSON_UTF_8.toString())
]]>
          </code>
        </script>
      </post>
      <metadata>
        <positionTop>
            94.4140625
        </positionTop>
        <positionLeft>
            412.28515625
        </positionLeft>
      </metadata>
    </task>
  </taskFlow>
  <metadata>
    <visualization>
      <![CDATA[ <html>
    <head>
    <link rel="stylesheet" href="/studio/styles/studio-standalone.css">
        <style>
        #workflow-designer {
            left:0 !important;
            top:0 !important;
            width:2688px;
            height:3295px;
            }
        </style>
    </head>
    <body>
    <div id="workflow-visualization-view"><div id="workflow-visualization" style="position:relative;top:-89.4140625px;left:-407.28515625px"><div class="task _jsPlumb_endpoint_anchor_ ui-draggable active-task" id="jsPlumb_1_286" style="top: 94.4145px; left: 412.285px;"><a class="task-name" data-toggle="tooltip" data-placement="right" title="A task that returns information about the function or function version, with a link to download the deployment package that's valid for 10 minutes. If  you specify a function version, only details that are specific to that version are returned."><img src="/automation-dashboard/styles/patterns/img/wf-icons/lambda.png" width="20px">&nbsp;<span class="name">AWS_Lambda_Get_Function</span></a>&nbsp;&nbsp;<a id="called-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: 17px; right: 3px;"><i title="Workflows being Called by this Task" id="called-icon"></i></a><a title="Scripts being Called by this Task" id="reference-icon-a" href="javascript:void(0)" class="pointer" style=" position: inherit; top: -7px; right: 3px;"><i id="reference-icon"></i></a></div><div class="_jsPlumb_endpoint source-endpoint dependency-source-endpoint connected _jsPlumb_endpoint_anchor_ ui-draggable ui-droppable" style="position: absolute; height: 20px; width: 20px; left: 486.5px; top: 124px;"><svg style="position:absolute;left:0px;top:0px" width="20" height="20" pointer-events="all" position="absolute" version="1.1" xmlns="http://www.w3.org/1999/xhtml"><circle cx="10" cy="10" r="10" version="1.1" xmlns="http://www.w3.org/1999/xhtml" fill="#666" stroke="none" style=""></circle></svg></div></div></div>
    </body>
</html>
 ]]>
    </visualization>
  </metadata>
</job>